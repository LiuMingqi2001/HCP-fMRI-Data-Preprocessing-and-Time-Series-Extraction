# HCP-fMRI-Data-Preprocessing-and-Time-Series-Extraction

This repository provides a comprehensive workflow for preprocessing Human Connectome Project (HCP) fMRI data and extracting voxel-level and region-level time series from subcortical gray matter and cortical regions. The scripts leverage tools like FSL, `wb_command`, and Python libraries such as `nibabel` and `numpy`.

## Features

### Preprocessing
- Converts CIFTI `.dtseries.nii` files into NIfTI volumes for subcortical and cortical regions.
- Aligns subcortical gray matter from MNINonLinear space to individual T1 space (3mm resolution).
- Splits, downsamples, and concatenates fMRI volumes for voxel-level time-series analysis.

### Time-Series Extraction
#### Subcortical Regions:
- Extracts voxel-level time series based on seed point coordinates.
- Outputs CSV files for left and right hemispheres.

#### Cortical Regions:
- Extracts average time series for cortical sub-areas based on FreeSurfer segmentation.
- Handles left and right hemisphere data separately.

---

## Directory Structure

The repository expects the following structure for HCP data:

```
HCP/
│
├── <subject_name>/
│   ├── T1/
│   │   ├── T1_3mm.nii.gz
│   │   └── ...
│   ├── <subject_name>_3T_rfMRI_REST_fix/
│   │   ├── MNINonLinear/
│   │   │   ├── Results/
│   │   │   │   ├── rfMRI_REST1_LR/
│   │   │   │   │   └── rfMRI_REST1_LR_Atlas_hp2000_clean.dtseries.nii
│   │   │   │   └── rfMRI_REST1_RL/
│   │   │   │       └── rfMRI_REST1_RL_Atlas_hp2000_clean.dtseries.nii
│   │   └── ...
│   ├── <subject_name>_3T_Structural_preproc/
│   │   ├── MNINonLinear/
│   │   │   ├── xfms/
│   │   │   │   └── standard2acpc_dc.nii.gz
│   │   └── ...
│   └── ...
```

---

## Scripts

### `fmri_to_individual_space_registration.py`
**Purpose**: Aligns subcortical gray matter voxels from MNINonLinear space to individual T1 space (3mm resolution) and generates downsampled time series.

**Input**:
- fMRI data: `rfMRI_REST{phase}_{direction}_Atlas_hp2000_clean.dtseries.nii`.
- Structural data: `standard2acpc_dc.nii.gz` and `T1_3mm.nii.gz`.

**Output**:
- `fMRI_downsampled_3mm.nii.gz`: Aligned and downsampled fMRI time-series data.

**Usage**:
Ensure paths are properly set in the script, then run:
```bash
python fmri_to_individual_space_registration.py
```

---

### `striatum_time_series_extract.py`
**Purpose**: Extracts voxel-level time series for the striatum using seed point coordinates.

**Input**:
- Aligned fMRI data: `fMRI_downsampled_3mm.nii.gz` (generated by the first script).
- Coordinate file: `probtrackx_{hemisphere}_omatrix2/coords_for_fdt_matrix2`.

**Output**:
- `voxel_time_series_left.csv` and `voxel_time_series_right.csv`: CSV files containing voxel-level time series for each hemisphere.

**Usage**:
Ensure paths for input data are hardcoded in the script, then run:
```bash
python striatum_time_series_extract.py
```

---

### `cortex_time_series_extract.py`
**Purpose**: Extracts average time series for cortical sub-areas based on FreeSurfer segmentation.

**Input**:
- fMRI data: `rfMRI_REST{phase}_{direction}_Atlas_hp2000_clean.dtseries.nii`.

**Output**:
- `cortex_time_series_left.csv` and `cortex_time_series_right.csv`: CSV files containing average time series for cortical sub-areas in each hemisphere.

**Usage**:
Ensure paths are set in the script, then run:
```bash
python cortex_time_series_extract.py
```

---

## Installation

### Prerequisites
Install the required tools:
- **FSL**: [Download Link](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki)
- **wb_command**: Part of Connectome Workbench. [Download Link](https://www.humanconnectome.org/software/connectome-workbench)

### Python Dependencies
Install required libraries:
```bash
pip install numpy nibabel
```

---

## Workflow

### Preprocess fMRI Data
Run `fmri_to_individual_space_registration.py` to align and downsample fMRI data:
```bash
python fmri_to_individual_space_registration.py
```

### Extract Striatum Time Series
Extract voxel-level time series for the striatum:
```bash
python striatum_time_series_extract.py
```

### Extract Cortical Time Series
Extract average time series for cortical sub-areas:
```bash
python cortex_time_series_extract.py
```

---

## Outputs

### Subcortical Region Time Series:
- `voxel_time_series_left.csv` and `voxel_time_series_right.csv`.

### Cortical Region Time Series:
- `cortex_time_series_left.csv` and `cortex_time_series_right.csv`.

---

## License
This project is licensed under the MIT License.
